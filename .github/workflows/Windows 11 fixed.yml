name: RDP-FULL-SETUP

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: self-hosted
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: powershell
        run: |
          $password = "sasuke20233"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (Get-LocalUser RDP -ErrorAction SilentlyContinue) {
            Set-LocalUser RDP -Password $securePass
          } else {
            New-LocalUser RDP `
              -Password $securePass `
              -AccountNeverExpires `
              -PasswordNeverExpires
          }

          Add-LocalGroupMember Administrators RDP -ErrorAction SilentlyContinue
          Add-LocalGroupMember "Remote Desktop Users" RDP -ErrorAction SilentlyContinue

      - name: Install Tailscale (MSI)
        shell: powershell
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $url -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        shell: powershell
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=rdp-node

      - name: Install getscreen.me
        shell: powershell
        run: |
          $url = "https://getscreen.me/download/windows"
          $exe = "$env:TEMP\getscreen.exe"
          Invoke-WebRequest $url -OutFile $exe
          Start-Process $exe -ArgumentList "/S" -Wait

      - name: Install Stardesk
        shell: powershell
        run: |
          $url = "https://www.stardesk.app/download/windows"
          $exe = "$env:TEMP\stardesk.exe"
          Invoke-WebRequest $url -OutFile $exe
          Start-Process $exe -ArgumentList "/S" -Wait

      - name: Install Sandboxels (Web App)
        shell: powershell
        run: |
          $path = "C:\Sandboxels"
          New-Item -ItemType Directory -Force -Path $path
          Start-Process "msedge.exe" "https://sandboxels.r74n.com"

      - name: Info
        run: |
          echo =====================
          echo RDP READY
          echo USER: RDP
          echo PASS: sasuke20233
          echo =====================

      - name: Keep alive
        run: |
          while ($true) { Start-Sleep 300 }
